<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>AR Robot Simple Mission</title>
<style>body{margin:0;overflow:hidden;}canvas{display:block;}</style>
</head>
<body>

<script src="https://cdn.jsdelivr.net/npm/three@0.128/build/three.min.js"></script>
<script type="module">
import { ARButton } from 'https://cdn.jsdelivr.net/npm/three@0.128/examples/jsm/webxr/ARButton.js';

let scene, camera, renderer;
let robot, beds = [], targets = [], missionStep = 0;

// --- init ---
init();
animate();

function init(){
  scene = new THREE.Scene();
  camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.01, 20);
  renderer = new THREE.WebGLRenderer({antialias:true,alpha:true});
  renderer.setSize(window.innerWidth,window.innerHeight);
  renderer.xr.enabled = true;
  document.body.appendChild(renderer.domElement);
  document.body.appendChild(ARButton.createButton(renderer,{requiredFeatures:['hit-test']}));

  const light = new THREE.HemisphereLight(0xffffff,0x444444,1);
  scene.add(light);

  // --- Simple robot ---
  const body = new THREE.Mesh(new THREE.BoxGeometry(0.3,0.4,0.2), new THREE.MeshStandardMaterial({color:0x00ffff}));
  robot = new THREE.Group(); body.position.y=0.2; robot.add(body);
  scene.add(robot);

  // --- Beds ---
  const bedMat = new THREE.MeshStandardMaterial({color:0xff9999});
  const bed1 = new THREE.Mesh(new THREE.BoxGeometry(0.5,0.1,0.25), bedMat); bed1.position.set(0.8,0, -0.5);
  const bed2 = new THREE.Mesh(new THREE.BoxGeometry(0.5,0.1,0.25), bedMat); bed2.position.set(-0.8,0,-0.5);
  scene.add(bed1, bed2); beds.push(bed1, bed2);

  // --- click to move robot ---
  window.addEventListener('click', (e)=>{
    // pick nearest bed that still has mission
    if(missionStep < beds.length){
      targets[missionStep] = beds[missionStep].position.clone();
      missionStep++;
    }
  });
}

function showMessage(text,pos){
  const canvas=document.createElement('canvas'); canvas.width=256; canvas.height=128;
  const ctx=canvas.getContext('2d');
  ctx.fillStyle="rgba(255,255,255,0)"; ctx.fillRect(0,0,256,128);
  ctx.font="20px Arial"; ctx.fillStyle="#ff3399"; ctx.textAlign="center"; ctx.fillText(text,128,64);
  const tex=new THREE.CanvasTexture(canvas);
  const sprite=new THREE.Sprite(new THREE.SpriteMaterial({map:tex,transparent:true}));
  sprite.position.copy(pos); sprite.position.y+=0.3; sprite.scale.set(0.6,0.3,0.3);
  scene.add(sprite); setTimeout(()=>scene.remove(sprite),2000);
}

function animate(){
  renderer.setAnimationLoop(render);
}

function render(){
  if(robot && targets.length>0){
    for(let i=0;i<targets.length;i++){
      if(targets[i]){
        const dir=new THREE.Vector3().subVectors(targets[i],robot.position);
        if(dir.length()>0.02){ dir.multiplyScalar(0.05); robot.position.add(dir); }
        else{
          showMessage("Medicine Delivered!", targets[i]);
          targets[i]=null;
          // if all done, show confetti
          if(targets.every(t=>t===null)){ 
            showMessage("Mission Successful!", robot.position);
            confetti({ particleCount:200, spread:120, origin:{y:0.6} });
          }
        }
      }
    }
  }
  renderer.render(scene,camera);
}

// --- confetti ---
const script=document.createElement('script'); script.src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js";
document.body.appendChild(script);
</script>
</body>
</html>
